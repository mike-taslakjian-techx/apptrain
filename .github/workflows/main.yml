name: Deploy to DEV
on:
  push:
    tags:
      - 'dev-*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to DEV environment via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_SERVER }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Navigate to your app folder
            cd /root/Mike/

            # 2. Get the latest code from GitHub
            git fetch --all
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            # 3. Clean up old unused data to save disk space
            docker system prune -f

            # 4. Start the app using the .env file from the vault folder
            # --env-file tells Compose to use your extracted secrets
            # --build ensures it rebuilds the images with the new code
            docker compose --env-file /root/vault/.env up -d --build
            
